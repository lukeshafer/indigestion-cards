---
import { Bucket } from 'sst/node/bucket';
import { createPresignedPost } from '@aws-sdk/s3-presigned-post';
import { S3Client } from '@aws-sdk/client-s3';
import crypto from 'crypto';
import Page from '@/layouts/Page.astro';
import Form from '@/components/form/Form.astro';
import { routes } from '@/constants';

const s3 = new S3Client({ region: 'us-east-2' });
const presigned = await createPresignedPost(s3, {
	Bucket: Bucket.CardDesigns.bucketName,
	Key: crypto.randomBytes(20).toString('hex') + '.jpg',
	Fields: {
		acl: 'public-read',
		success_action_redirect: Astro.url.origin + routes.ADMIN.CREATE.CARD_DESIGN_DETAILS,
		'x-amz-meta-test': 'test',
	},
});
---

<Page
	title="Create New Card"
	class="grid gap-4"
	breadcrumbs={[
		{ label: 'Home', href: '/' },
		{ label: 'Designs', href: routes.DESIGNS },
		{ label: 'New Card', href: routes.ADMIN.CREATE.CARD_DESIGN },
	]}>
	<h1 class="page-heading">Create New Card</h1>
	<div hx-disable>
		<Form method="post" action={presigned.url} enctype="multipart/form-data">
			{
				Object.entries(presigned.fields).map(([key, value]) => (
					<input type="hidden" name={key} value={value} />
				))
			}
			<div class="input-group">
				<label data-for="file" for="file">Please upload the card image</label>
				<input type="file" name="file" id="file" accept="image/jpeg" required />
			</div>
			<button type="submit">Upload</button>
		</Form>
	</div>
</Page>
