---
import Page from '@/layouts/Page.astro';
import { getAllSeasons, getAllRarities } from '@lil-indigestion-cards/core/card';
import { api, routes } from '@/constants';
import CardDesignForm from '@/components/entity-forms/CardDesignForm.astro';

const bucket = Astro.url.searchParams.get('bucket');
const key = Astro.url.searchParams.get('key');

if (!bucket || !key) {
	return Astro.redirect('/?alert=Please upload an image first');
}

const imgUrl = `https://${bucket}.s3.amazonaws.com/${key}`;
const seasons = await getAllSeasons();
const rarities = await getAllRarities();
---

<Page
	title="Add Card Design"
	breadcrumbs={[
		{ href: '/', label: 'Home' },
		{ href: routes.DESIGNS, label: 'Designs' },
		{ href: routes.ADMIN.CREATE.CARD_DESIGN, label: 'New Card' },
		{ label: 'Details' },
	]}>
	<h1 class="page-heading">Add Card Design</h1>
	<div class="flex flex-col pt-8 gap-8 max-w-4xl">
		<div class="relative">
			<img src={imgUrl} class="w-60 h-auto object-contain mb-4" />
			<button
				class="post-button"
				hx-delete={api.IMAGE.DELETE}
				hx-swap="none"
				hx-vals={JSON.stringify({ key, type: 'cardDesign' })}
				data-type="delete">Delete Draft<form-indicator></form-indicator></button
			>
		</div>

		<CardDesignForm
			rarities={rarities}
			seasons={seasons}
			key={key}
			bucket={bucket}
			action={`${api.CREATE_CARD_DESIGN}?redirect=${routes.DESIGNS}`}
		/>
	</div>
</Page>
