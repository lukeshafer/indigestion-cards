---
import Page from '@/layouts/Page.astro';
import { getAllSeasons, getAllRarities } from '@lil-indigestion-cards/core/card';
import { api, routeNames, routes } from '@/constants';
import PageHeading from '@/components/text/PageHeading.astro';
import Card from '@/components/Card.astro';
import { getSiteConfig } from '@lil-indigestion-cards/core/site-config';

const bucket = Astro.url.searchParams.get('bucket');
const key = Astro.url.searchParams.get('key');

if (!bucket || !key) {
	return Astro.redirect('/?alert=Please upload an image first');
}

const imgUrl = `https://${bucket}.s3.amazonaws.com/${key}`;
const seasons = await getAllSeasons();
const rarities = await getAllRarities();
const { baseRarity } = await getSiteConfig();
---

<Page
	title="Add Card Design"
	breadcrumbs={[
		{ href: routes.DESIGNS, label: routeNames.CARDS },
		{ href: routes.ADMIN.CREATE.CARD_DESIGN, label: 'New Card' },
		{ label: 'Details' },
	]}>
	<PageHeading>Add Card Design</PageHeading>
	<div
		class="flex max-w-4xl flex-col gap-8 pt-8"
		x-data="{ preview_cardName: '', preview_cardDescription: '' }">
		<div class="relative grid justify-start gap-4">
			<Card
				preview
				rarityName={baseRarity.rarityName}
				rarityColor={baseRarity.rarityColor}
				frameUrl={baseRarity.frameUrl}
				{imgUrl}
				cardName=""
				cardDescription=""
				designId=""
				cardNumber={1}
				totalOfType={1}
			/>
			<button
				class="post-button"
				hx-delete={api.IMAGE.DELETE}
				hx-swap="none"
				hx-vals={JSON.stringify({ key, type: 'cardDesign' })}
				data-type="delete">Delete Draft<form-indicator></form-indicator></button
			>
		</div>

		<my-form>
			<form action={api.DESIGN.CREATE} method="post" hx-swap="none">
				<input type="hidden" name="imgUrl" value={imgUrl} />
				<input type="hidden" name="imageKey" value={key} />
				<div class="input-group">
					<label for="season">Season</label>
					<select name="season" required>
						{
							seasons.map(({ seasonId, seasonName }) => (
								<option value={JSON.stringify({ seasonId, seasonName })}>
									{seasonName}
								</option>
							))
						}
					</select>
				</div>
				<div class="input-group">
					<label for="cardName">Card Name</label>
					<input name="cardName" id="cardName" required x-model="preview_cardName" />
				</div>
				<div class="input-group">
					<label for="designId">Id</label>
					<input
						data-id-from="cardName"
						data-edit-button
						name="designId"
						id="designId"
						required
						readonly
					/>
				</div>
				<div class="input-group">
					<label for="cardDescription">Description</label>
					<textarea name="cardDescription" required x-model="preview_cardDescription"
					></textarea>
				</div>
				<div class="input-group">
					<label for="artist">Artist</label>
					<input name="artist" required />
				</div>
				<fieldset>
					<legend>Rarity Details</legend>
					{
						rarities.map(({ rarityId, rarityName, defaultCount }) => (
							<div class="input-group">
								<label for={`rarity-${rarityId}-count`}>{rarityName}</label>
								<input
									title={rarityName + ' Count'}
									name={`rarity-${rarityId}-count`}
									type="number"
									required
									value={defaultCount}
								/>
							</div>
						))
					}
				</fieldset>
				<button type="submit">Save</button>
			</form>
		</my-form>
	</div>
</Page>
