---
import Page from '@/layouts/Page.astro';
import { getAllSeasons, getAllRarities } from '@lil-indigestion-cards/core/card';
import { routeNames, routes } from '@/constants';
import { PageTitle, PageHeader } from '@/components/text';
import { getSiteConfig } from '@lil-indigestion-cards/core/site-config';
import CardDesignForm from '@/components/design/CardDesignForm';

const bucket = Astro.url.searchParams.get('bucket');
const key = Astro.url.searchParams.get('key');

if (!bucket || !key) {
	return Astro.redirect('/?alert=Please upload an image first');
}

const imgUrl = `https://${bucket}.s3.amazonaws.com/${key}`;
const seasons = await getAllSeasons();
const rarities = await getAllRarities();
const config = await getSiteConfig();
const baseRarity = config?.baseRarity ??
	rarities[0] ?? {
		rarityId: 'default',
		rarityName: 'Default',
		rarityColor: '#fff',
		frameUrl: '/default-base-rarity.png',
	};
---

<Page
	title="Add Card Design"
	breadcrumbs={[
		{ href: routes.DESIGNS, label: routeNames.CARDS },
		{ href: routes.ADMIN.CREATE.CARD_DESIGN, label: 'New Card' },
		{ label: 'Details' },
	]}>
	<PageHeader>
		<PageTitle>Add Card Design</PageTitle>
	</PageHeader>
	<CardDesignForm {imgUrl} {key} {seasons} {rarities} {baseRarity} client:load />
</Page>
