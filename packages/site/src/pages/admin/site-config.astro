---
import Page from '@/layouts/Page.astro';
import { getAllPackTypes, getAllRarities } from '@lil-indigestion-cards/core/card';
import { getTwitchEvents, getSiteConfig } from '@lil-indigestion-cards/core/site-config';
import { TWITCH_GIFT_SUB_ID } from '@lil-indigestion-cards/core/constants';
import TwitchLoginButton from '@/components/site-config/TwitchLoginButton.astro';
import { PageTitle, PageHeader } from '@/components/text';
import SiteConfigForm from '@/components/site-config/SiteConfigForm';
import RefreshTwitchEventsButton from '@/components/site-config/RefreshTwitchEventsButton';

const [twitchEvents, packTypes, rarities, siteConfig] = await Promise.all([
	getTwitchEvents(),
	getAllPackTypes(),
	getAllRarities(),
	getSiteConfig(),
]);

const baseRarityValue = new URLSearchParams(
	siteConfig?.baseRarity || {
		rarityId: rarities[0].rarityId,
		frameUrl: rarities[0].frameUrl,
	}
).toString();

const giftSubEvent = twitchEvents.data.find(
	(event) =>
		event.eventType === 'channel.subscription.gift' && event.eventId === TWITCH_GIFT_SUB_ID
) || {
	eventId: TWITCH_GIFT_SUB_ID,
	eventName: '5 Gift Subs',
	eventType: 'channel.subscription.gift',
};

const rewards = twitchEvents.data
	.filter((event) => event.eventType === 'channel.channel_points_custom_reward_redemption.add')
	.sort((a, b) => {
		if (a.packTypeId && !b.packTypeId) return -1;
		if (!a.packTypeId && b.packTypeId) return 1;
		if (a.eventName.toLowerCase() < b.eventName.toLowerCase()) return -1;
		if (a.eventName.toLowerCase() > b.eventName.toLowerCase()) return 1;
		return 0;
	});
---

<Page breadcrumbs={[{ label: 'Config' }]} title="Site Config">
	<PageHeader>
		<PageTitle>Site Config</PageTitle>
	</PageHeader>

	<div class="max-w-2xl mx-auto my-6">
		<SiteConfigForm
			{rarities}
			{packTypes}
			twitchEvents={rewards}
			{giftSubEvent}
			{baseRarityValue}
			client:load
		/>
	</div>
	<RefreshTwitchEventsButton client:load />
	<TwitchLoginButton />
</Page>
