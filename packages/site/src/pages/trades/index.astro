---
// DATA
import { getAllTradesForUser } from '@lil-indigestion-cards/core/lib/trades';

// UI
import { PageHeader, PageTitle, Heading } from '@/components/text';
import { routeNames, routes } from '@/constants';
import Page from '@/layouts/Page.astro';
import { Anchor } from '@/components/text';
import TradesTable from '@/components/trades/TradesTable.astro';
import { getUser } from '@lil-indigestion-cards/core/lib/user';
import type { Trade } from '@lil-indigestion-cards/core/db/trades';

const userId = Astro.locals.user?.properties.userId;
const username = Astro.locals.user?.properties.username;

if (!userId || !username) {
	return Astro.redirect('/?alert=You must be logged in to view this page.&type=error');
}

const trades = await getAllTradesForUser(userId);

const pending: Trade[] = [];
const complete: Trade[] = [];

for (const trade of trades.incoming) {
	if (trade.status === 'pending') pending.push(trade);
	else complete.push(trade);
}
for (const trade of trades.outgoing) {
	if (trade.status === 'pending') pending.push(trade);
	else complete.push(trade);
}

const user = await getUser(userId);
---

<Page title="Trades" pageType="user" breadcrumbs={[{ label: routeNames.TRADES }]}>
	<PageHeader>
		<PageTitle>My Trades</PageTitle>
		<div class="right-4 flex w-full justify-center sm:absolute sm:w-auto">
			<Anchor href={`${routes.TRADES}/new`}>New Trade</Anchor>
		</div>
	</PageHeader>

	<section aria-labelledby="open-trades">
		<h2 id="open-trades" class="sr-only">Open Trades</h2>
		<TradesTable trades={pending} userTradeNotifications={user?.tradeNotifications} />
	</section>

	<br />
  
  <details>
    <summary>Closed Trades</summary>
		<TradesTable trades={complete} userTradeNotifications={user?.tradeNotifications} />
  </details>
</Page>
