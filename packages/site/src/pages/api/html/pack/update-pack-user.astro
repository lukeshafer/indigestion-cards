---
import { updatePackUser } from '@lil-indigestion-cards/core/pack';
import { getUserByLogin } from '@lil-indigestion-cards/core/twitch-helpers';
import { getUserByUserName } from '@lil-indigestion-cards/core/user';
import { getPackById } from '@lil-indigestion-cards/core/card';
import { api } from '@/constants';
import Alert from '@/components/Alert.astro';

const packId = Astro.url.searchParams.get('packId');
const username = Astro.url.searchParams.get('username');
const id = Astro.url.searchParams.get('id');

if (!packId) {
	console.error('Missing packId');
	return new Response('Missing packId', { status: 400 });
}
if (!username) {
	console.error('Missing username');
	return new Response('Missing username', { status: 400 });
}
if (!id) {
	console.error('Missing id');
	return new Response('Missing id', { status: 400 });
}

const pack = await getPackById({ packId });

if (!pack) {
	console.error('Pack not found');
	return new Response('Pack not found', { status: 404 });
}

const userId = (await getUserByUserName(username))?.userId ?? (await getUserByLogin(username))?.id;

if (userId) {
	Astro.response.headers.set('HX-Trigger', 'clearAlert');
	if (pack.username !== username) await updatePackUser({ packId, username, userId });
}
---

<body>
	{
		!userId ? (
			<>
				<Alert type="error">Twitch user {username} not found.</Alert>
				<span {id} hx-swap-oob="true">
					{pack.username}
				</span>
				<button
					class="post-button edit-button"
					data-type="submit"
					hx-select=".save-button"
					hx-swap="outerHTML"
					hx-vals={JSON.stringify({
						id,
						username: pack.username,
						packId,
					})}
					hx-get={api.PACK.START_EDIT}>
					Edit
				</button>
			</>
		) : (
			<>
				<span {id} hx-swap-oob="true">
					{username}
				</span>
				<button
					@htmx:load="setTimeout(() => { $el.innerText = 'Edit'; $el.dataset.type = 'submit'; }, 1000)"
					class="post-button edit-button"
					data-type="success"
					hx-select=".save-button"
					hx-swap="outerHTML"
					hx-vals={JSON.stringify({
						id,
						username,
						packId,
					})}
					hx-get={api.PACK.START_EDIT}>
					Saved
				</button>
			</>
		)
	}
</body>
