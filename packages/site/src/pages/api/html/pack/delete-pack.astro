---
import { deleteFirstPackForUser } from '@lil-indigestion-cards/core/card';
import Alert from '@/components/Alert.astro';
import Show from '@/components/Show.astro';

const method = Astro.request.method.toUpperCase();
const body = await Astro.request.text();
const params = new URLSearchParams(body);

if (method !== 'DELETE') {
	return new Response('Invalid method', { status: 405 });
}

const userId = params.get('userId');
const username = params.get('username');

Astro.response.headers.set('HX-Trigger', '{ "refreshCount": "true" }');
---

<body>
	<Show when={userId && username}>
		{
			deleteFirstPackForUser({ username: username!, userId: userId! }).then((result) =>
				!result || !result.success ? (
					<Alert type="error">Failed to revoke pack</Alert>
				) : (
					<Alert type="success">
						Revoked 1 pack for <strong>{username}</strong>
					</Alert>
				)
			)
		}
		<div slot="fallback">
			<Alert type="error">Missing parameters</Alert>
		</div>
	</Show>
</body>
