---
import AdminUserRow from '@/components/admin-users/AdminUserRow.astro';
// @ts-ignore -- typescript is erroring here even though it's valid
import { html } from '@/lib/template-tags';
import { getUserByLogin } from '@lil-indigestion-cards/core/twitch-helpers';
import { createAdminUser } from '@lil-indigestion-cards/core/user';

const body = await Astro.request.text();

const username = new URLSearchParams(body).get('username');
if (!username)
	return html`<body></body>`.response({
		headers: {
			'HX-Trigger': 'clearAlert',
		},
	});

const user = await getUserByLogin(username);
if (!user) return new Response('User not found', { status: 404 });
const { display_name, id } = user;

const result = await createAdminUser({ userId: id, username: display_name });

if (!result.success)
	return new Response(result.error, {
		status: 400,
		headers: {
			'HX-Trigger': JSON.stringify({
				displayAlert: {
					type: 'error',
					message: result.error,
				},
			}),
		},
	});
---

<body>
	<AdminUserRow username={display_name} userId={id} />
</body>
