---
import Alert from '@/components/Alert.astro';
import AdminUserRow from '@/components/admin-users/AdminUserRow.astro';
import { getUserByLogin } from '@lil-indigestion-cards/core/twitch-helpers';
import { createAdminUser } from '@lil-indigestion-cards/core/user';

const body = await Astro.request.text();

const username = new URLSearchParams(body).get('username');
if (!username) {
	return new Response('<body></body>', {
		headers: {
			'Content-Type': 'text/html; charset=utf-8',
			'HX-Trigger': 'clearAlert',
		},
	});
}

const user = await getUserByLogin(username);
if (!user) {
	return new Response('User not found', { status: 404 });
}
const { display_name, id } = user;

const result = await createAdminUser({ userId: id, username: display_name });
---

<body>
	{
		result.success ? (
			<AdminUserRow username={display_name} userId={id} isStreamer={false} />
		) : (
			<Alert type="error">{result.error}</Alert>
		)
	}
</body>
