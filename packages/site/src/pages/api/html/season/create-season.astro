---
import { createSeason } from '@lil-indigestion-cards/core/card';

const params = new URLSearchParams(await Astro.request.text());

const seasonName = params.get('seasonName');
const seasonId = params.get('seasonId');
const seasonDescription = params.get('seasonDescription') ?? undefined;

let errorMessage = '';
if (!seasonName) errorMessage += 'Missing name. ';
if (!seasonId) errorMessage += 'Missing seasonId. ';
if (!seasonId!.match(/^[a-z0-9-]+$/))
	errorMessage += 'Invalid seasonId. (Must be lowercase, numbers, and dashes only) ';
if (errorMessage) return { statusCode: 400, body: 'Error: ' + errorMessage };

const result =
	// @ts-expect-error - seasonDescription can be undefined
	await createSeason({
		seasonId: seasonId!,
		seasonName: seasonName!,
		seasonDescription,
	});

if (!result.success)
	return new Response(result.error, {
		status: result.error === 'Season already exists' ? 409 : 500,
		headers: {
			'HX-Trigger': JSON.stringify({
				createAlert: {
					message: result.error,
					type: 'error',
				},
			}),
		},
	});

Astro.response.headers.set(
	'HX-Redirect',
	`/season/${seasonId}?alert=Season%20created!&alertType=success`
);
---

<body></body>
