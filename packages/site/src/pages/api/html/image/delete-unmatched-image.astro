---
import Alert from '@/components/Alert.astro';
import { AUTH_TOKEN } from '@/constants';
import Redirect from '@/lib/redirect';
import { Api } from 'sst/node/api';

const params = new URLSearchParams(await Astro.request.text());

const key = params.get('key');
const type = params.get('type');

async function deleteImage() {
	if (!key) {
		return { success: false, error: 'Missing image key' };
	}

	if (type !== 'frame' && type !== 'cardDesign') {
		return { success: false, error: 'Invalid image type' };
	}

	const result = await fetch(Api.api.url + '/delete-unmatched-image', {
		method: 'DELETE',
		headers: {
			authorization: `Bearer ${Astro.cookies.get(AUTH_TOKEN).value ?? ''}`,
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({
			key,
			type,
		}),
	});

	if (!result.ok) {
		console.error(result);
		return { success: false, error: 'Error deleting image' };
	}

	return { success: true };
}

const result = await deleteImage();
---

<body>
	{
		result.success ? (
			<Redirect
				to={type === 'frame' ? '/rarity' : '/design'}
				alert="Image deleted"
				type="success"
				{Astro}
			/>
		) : (
			<Alert type="error">{result.error}</Alert>
		)
	}
</body>
