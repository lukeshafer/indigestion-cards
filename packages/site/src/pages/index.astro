---
import AdminOnly from '@/components/AdminOnly.astro';
import { authApi } from '@/constants';
import Page from '@/layouts/Page.astro';
import { Icon } from 'astro-icon';

const session = Astro.locals.session;
---

<Page title="index" breadcrumbs={[{ label: 'Home', href: '/' }]} pageType="public">
	<a href="/user" class="button-link">Users</a>
	<a
		hx-disable
		class="post-button mt-5 flex w-fit items-center bg-[#9146ff] text-white gap-2"
		href={authApi.LOGIN + (session?.type === 'admin' ? '?streamer=true' : '')}>
		<Icon name="mdi:twitch" width="50" />
		<span>
			{session?.type === 'admin' ? 'Authorize Streamer Permissions' : 'Login with Twitch'}
		</span>
	</a>
	<AdminOnly>
		<button class="post-button mt-5" id="refresh-twitch-button" data-type="submit"
			>Refresh Twitch Events</button
		>
	</AdminOnly>
	<!-- TODO: Add FAQ -->
</Page>

<script>
	const refreshButton = document.getElementById('refresh-twitch-button') as HTMLButtonElement;
	refreshButton.addEventListener('click', async () => {
		refreshButton.disabled = true;
		refreshButton.innerText = 'Refreshing...';
		const res = await fetch('/api/admin/refresh-twitch-event-subscriptions?fetch=true', {
			method: 'POST',
		});
		if (res.ok) {
			refreshButton.innerText = 'Refreshed!';
		} else {
			refreshButton.innerText = 'Error!';
		}
		refreshButton.disabled = false;
		setTimeout(() => {
			refreshButton.innerText = 'Refresh Twitch Events';
		}, 2000);
	});
</script>
