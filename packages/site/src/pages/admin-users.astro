---
import Page from '@/layouts/Page.astro';
import { useAdmin } from '@/session';
import { getAllAdminUsers } from '@lil-indigestion-cards/core/user';
import { api, routes } from '@/constants';
import SortTable from '@/components/SortTable.astro';
import PostButton from '@/components/form/PostButton.astro';

const admin = useAdmin(Astro.cookies);
if (!admin) return Astro.redirect(`/404`);

const unsortedUsers = await getAllAdminUsers();

const currentUser = admin.properties.userId;
const users = unsortedUsers.sort((a, b) => {
	if (a.userId === currentUser) return -1;
	if (b.userId === currentUser) return 1;
	return 0;
});
---

<Page
	title="Users"
	breadcrumbs={[{ label: 'Home', href: '/' }, { label: 'Users' }]}
	session={admin}>
	<sort-table>
		<header slot="header" class="flex justify-between flex-wrap mb-4">
			<h1 class="page-heading">Admin Users</h1>
			<a
				href={routes.ADMIN.CREATE.ADMIN}
				class="text-xl bg-brand-tertiary p-3 pt-4 px-4 text-center w-max font-display lowercase italic shine text-shadow text-white">
				Add Admin
			</a>
		</header>
		<table>
			<thead>
				<tr>
					<th class="w-3/4">Username</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				{
					users.map(({ username, userId }) => (
						<tr>
							<td>{username}</td>
							<td>
								{username !== admin.properties.username && (
									<PostButton
										id="delete-admin-user"
										label="Delete"
										type="delete"
										url={`${api.DELETE_ADMIN_USER}?redirect=${routes.ADMIN_USERS}`}
										hiddenProperties={[{ name: 'userId', value: userId }]}
									/>
								)}
							</td>
						</tr>
					))
				}
			</tbody>
		</table>
	</sort-table>
</Page>

