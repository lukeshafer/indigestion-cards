---
import { getAllRarities } from '@lil-indigestion-cards/core/card'
import { useAdmin } from '@/session'
import Page from '@/layouts/Page.astro'
import UnmatchedImageList from '@/components/UnmatchedImageList.astro'
import { api, routes } from '@/constants'
import SortTable from '@/components/SortTable.astro'
import PostButton from '@/components/form/PostButton.astro'

const admin = useAdmin(Astro.cookies)
if (!admin) return Astro.redirect('/404')

const rarities = await getAllRarities()
---

<Page
	title="Rarities"
	class="flex flex-col gap-4"
	session={admin}
	breadcrumbs={[
		{ label: 'Home', href: '/' },
		{ label: 'Rarities', href: routes.RARITIES },
	]}>
	<UnmatchedImageList type="frame" />
	<div class="flex flex-wrap gap-8">
		<h1 class="page-heading">Rarities</h1>
		<a href={routes.ADMIN.CREATE.RARITY} class="button-link">Create New Rarity</a>
	</div>
	<SortTable>
		<thead>
			<tr>
				<th class="w-1/2">Name</th>
				<th data-type="number">Default Count</th>
				<th data-no-sort>Actions</th>
			</tr>
		</thead>
		<tbody>
			{
				rarities.map(({ rarityName, rarityId, defaultCount }) => (
					<tr>
						<td>{rarityName}</td>
						<td>{defaultCount}</td>
						<td class="flex flex-row gap-2 text-sm justify-center">
							<a
								class="post-button"
								data-type="submit"
								href={`${routes.ADMIN.EDIT?.RARITY}/${rarityId}`}>
								Edit
							</a>
							<PostButton
								url={`${api.DELETE_RARITY}/${rarityId}`}
								type="delete"
								confirm
								id={`delete-rarity-${rarityId}`}
								label="Delete"
							/>
						</td>
					</tr>
				))
			}
		</tbody>
	</SortTable>
</Page>

<script>
	const forms = document.querySelectorAll('#rarity-list form') as NodeListOf<HTMLFormElement>

	forms.forEach((form) =>
		form.addEventListener('submit', async (e) => {
			const confirmation = confirm('Are you sure you want to delete this rarity?')
			if (!confirmation) e.preventDefault()
		})
	)
</script>
