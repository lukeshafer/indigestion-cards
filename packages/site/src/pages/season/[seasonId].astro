---
import CardList from '@/components/CardList.astro';
import Page from '@/layouts/Page.astro';
import {
	getPackTypesBySeasonId,
	getSeasonAndDesignsBySeasonId,
} from '@lil-indigestion-cards/core/card';
import PostButton from '@/components/form/PostButton.astro';
import { api, routes } from '@/constants';

const id = Astro.params.seasonId;

if (!id) {
	return Astro.redirect(`${routes.SEASONS}?alert=Season ID is required`);
}

const {
	season: [season],
	cardDesigns,
	cardInstances,
} = await getSeasonAndDesignsBySeasonId(id);

if (!season) {
	return Astro.redirect(`${routes.SEASONS}?alert='${id}' does not exist`);
}

const totalPossibleCards = cardDesigns.reduce((acc, card) => {
	return (
		acc +
		(card.rarityDetails?.reduce((acc, rarity) => {
			return acc + rarity.count;
		}, 0) ?? 0)
	);
}, 0);

const ownedCards = cardInstances.length;
const remainingCards = totalPossibleCards - ownedCards;

const packTypes = await getPackTypesBySeasonId({ seasonId: id });
const packTypesWithCardPools = await Promise.all(
	packTypes.map(async (packType) => {
		const totalPossiblePacks = Math.floor(totalPossibleCards / packType.cardCount);
		const openedPacks = ownedCards / packType.cardCount;
		const remainingPacks = Math.floor(remainingCards / packType.cardCount);
		return {
			...packType,
			totalPossiblePacks,
			openedPacks,
			remainingPacks,
		};
	})
);

const breadcrumbs = [
	{ label: 'Home', href: '/' },
	{ label: 'Seasons', href: routes.SEASONS },
	{ label: season.seasonName, href: `${routes.SEASONS}/${id}` },
];
---

<Page title={season.seasonName} class="flex flex-col gap-4" breadcrumbs={breadcrumbs}>
	<h1 class="page-heading">{season.seasonName}</h1>
	{
		season.seasonDescription ? (
			<p class="text-lg">Description: {season.seasonDescription}</p>
		) : null
	}

	<section class="text-lg">
		<h2 class="sub-heading">Stats:</h2>
		<p>Total cards in season: {totalPossibleCards}</p>
		<p>Cards distributed: {ownedCards}</p>
		<p>Card remaining to distribute: {remainingCards}</p>

		<h3 class="sub-heading text-xl mt-4">Pack Types:</h3>
		<ul>
			{
				packTypesWithCardPools.map(async (packType) => (
					<li>
						<b>{packType.packTypeName}</b>: {packType.totalPossiblePacks} total
						{packType.totalPossiblePacks === 1 ? 'pack' : 'packs'},{' '}
						{packType.remainingPacks}
						{packType.remainingPacks === 1 ? 'pack' : 'packs'} remaining to be opened
					</li>
				))
			}
		</ul>
	</section>

	<h2 class="sub-heading">Cards:</h2>
	<CardList cards={cardDesigns} />

	<PostButton
		id="delete-season"
		type="delete"
		label="Delete Season"
		url={`${api.DELETE_CARD_SEASON}/${id}?redirect=${routes.SEASONS}`}
	/>
</Page>

<script>
	const form = document.getElementById('delete-season') as HTMLFormElement;

	form.addEventListener('submit', async (e) => {
		const confirmation = confirm('Are you sure you want to delete this season?');
		if (!confirmation) e.preventDefault();
	});
</script>
