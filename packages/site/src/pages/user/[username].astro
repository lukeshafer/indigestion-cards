---
import CardList from '@/components/CardList.astro';
import Page from '@/layouts/Page.astro';
import { getUserAndCardInstances, createNewUser } from '@lil-indigestion-cards/core/user';
import { getUserByLogin } from '@lil-indigestion-cards/core/twitch-helpers';
import { api, routes, routeNames } from '@/constants';
import AdminOnly from '@/components/AdminOnly.astro';
import { getAllPackTypes } from '@lil-indigestion-cards/core/card';
import PageHeading from '@/components/text/PageHeading.astro';
import SubHeading from '@/components/text/SubHeading.astro';

const redirectCount = Number(Astro.url.searchParams.get('redirect')) || 0;
if (redirectCount > 3) {
	return Astro.redirect(`${routes.USERS}?alert=Username not found`);
}

const id = Astro.params.username;

if (!id) {
	return Astro.redirect(`${routes.USERS}?alert=Username is required`);
}

let data = await getUserAndCardInstances({ username: id });

const twitchData = await getUserByLogin(id);
if (!data) {
	if (twitchData) {
		const newUser = await createNewUser({
			username: twitchData.display_name,
			userId: twitchData.id,
		});
		data = {
			users: [newUser],
			cardInstances: [],
		};
		return Astro.redirect(`${routes.USERS}/${id}?redirect=${redirectCount + 1}`);
	}
	return Astro.redirect(`${routes.USERS}?alert=Username not found`);
}

const { users, cardInstances } = data;
const user = users[0]!;

const cardsNotInPack = cardInstances.filter((card) => !!card.openedAt);

const packTypes = await getAllPackTypes();
---

<Page
	title={user.username}
	class="flex flex-col gap-4"
	breadcrumbs={[{ label: routeNames.USER, href: routes.USERS }, { label: user.username }]}
	pageType="public">
	<header class="flex flex-col items-center gap-4 sm:gap-12 p-4 sm:flex-row sm:items-start">
		<img
			src={twitchData?.profile_image_url}
			width="200"
			class="col-start-1 row-span-full rounded-full"
		/>
		<AdminOnly>
			<section slot="fallback" class="flex flex-col gap-2">
				<PageHeading>{user.username}</PageHeading>
			</section>
			<section class="flex flex-col gap-2">
				<PageHeading>{user.username}</PageHeading>
				<p class="-mt-5">User Id: {user.userId}</p>
				<div class="col-start-2 flex w-full flex-wrap items-center gap-2">
					<input type="hidden" name="userId" value={user.userId} />
					<input type="hidden" name="username" value={user.username} />

					<select
						id="packTypeSelect"
						name="packType"
						class="my-form-input h-full w-40"
						required>
						<option value="">Choose Pack</option>
						{
							packTypes.map((packType) => (
								<option value={JSON.stringify(packType)}>
									{packType.packTypeName}
								</option>
							))
						}
					</select>

					<button
						class="post-button"
						data-type="submit"
						hx-post={api.PACK.CREATE}
						hx-include="[name=packType]"
						hx-swap="none"
						hx-vals={JSON.stringify({
							userId: user.userId,
							username: user.username,
						})}>Give Pack</button
					>
				</div>

				<div class="flex w-full flex-wrap items-center gap-2">
					<h2 class="text-lg">
						Unopened Packs: <span
							hx-get={api.PACK.GET_PACK_COUNT_FOR_USER}
							hx-trigger="refreshCount from:body"
							hx-vals={JSON.stringify({ userId: user.userId })}
							hx-swap="innerHTML transition:false"
							data-value={user.packCount}>{user.packCount}</span
						>
					</h2>
					<button
						class="post-button shine"
						data-type="delete"
						hx-delete={api.PACK.DELETE}
						hx-swap="none"
						hx-vals={JSON.stringify({
							userId: user.userId,
							username: user.username,
						})}>
						Revoke Pack
						<div class="htmx-indicator">Deleting</div>
					</button>
				</div>
			</section>
		</AdminOnly>
	</header>
	<section class="my-4 grid gap-4 text-center">
		<SubHeading>Cards</SubHeading>
		<CardList
			cards={cardsNotInPack.map((card) => ({
				cardName: card.cardName,
				designId: card.designId,
				frameUrl: card.frameUrl,
				imgUrl: card.imgUrl,
				cardNumber: card.cardNumber,
				rarityName: card.rarityName,
				cardDescription: card.cardDescription,
				totalOfType: card.totalOfType,
			}))}
		/>
	</section>
</Page>
