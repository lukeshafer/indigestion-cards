---
import CardList from '@/components/cards/CardList';
import Page from '@/layouts/Page.astro';
import { getUserAndCardInstances, createNewUser } from '@lil-indigestion-cards/core/user';
import { getUserByLogin } from '@lil-indigestion-cards/core/twitch-helpers';
import { routes, routeNames } from '@/constants';
import AdminOnly from '@/components/AdminOnly.astro';
import { getAllPackTypes } from '@lil-indigestion-cards/core/card';
import { Heading } from '@/components/text';
import UserPackForms from '@/components/pack/UserPackForms';
import UserLookingFor from '@/components/user/UserLookingFor';

const redirectCount = Number(Astro.url.searchParams.get('redirect')) || 0;
if (redirectCount > 3) {
	return Astro.redirect(`${routes.USERS}?alert=Username not found`);
}

const id = Astro.params.username;

if (!id) {
	return Astro.redirect(`${routes.USERS}?alert=Username is required`);
}

let data = await getUserAndCardInstances({ username: id });

const twitchData = await getUserByLogin(id);
if (!data) {
	if (twitchData) {
		const newUser = await createNewUser({
			username: twitchData.display_name,
			userId: twitchData.id,
		});
		data = {
			users: [newUser],
			cardInstances: [],
			userLogins: [],
		};
		return Astro.redirect(`${routes.USERS}/${id}?redirect=${redirectCount + 1}`);
	}
	return Astro.redirect(`${routes.USERS}?alert=Username not found`);
}

const { users, cardInstances } = data;
const user = users[0] || {
	username: id,
	userId: twitchData?.id,
};

const cardsNotInPack = cardInstances.filter((card) => !!card.openedAt);

const isLoggedInUser = Astro.locals.user?.properties.userId === user.userId;

const packTypes = await getAllPackTypes();
---

<Page
	title={user.username}
	class="flex flex-col gap-4"
	breadcrumbs={[{ label: routeNames.USER, href: routes.USERS }, { label: user.username }]}
	pageType="public">
	<header class="flex flex-col gap-4 gap-x-8 p-4 sm:flex-row">
		<img
			src={twitchData?.profile_image_url}
			width="150"
			height="150"
			class="col-start-1 row-span-full rounded-full h-fit"
		/>
		<section class="flex flex-col mt-4">
			<h1
				class="font-display my-2 text-4xl font-bold italic text-gray-600"
				style={{ 'view-transition-name': `${user.username}-username` }}>
				{user.username}
			</h1>
			<AdminOnly>
				<details>
					<summary class="text-gray-500 -mt-4">Admin Stuff</summary>
					<div class="bg-gray-100 p-3 rounded">
						<p>User Id: {user.userId}</p>
						<UserPackForms {user} {packTypes} client:load />
					</div>
				</details>
			</AdminOnly>
			<ul>
				<li>
					<UserLookingFor {user} {isLoggedInUser} client:load />
				</li>
			</ul>
		</section>
	</header>
	<section class="my-4 grid gap-4 text-center">
		<Heading>Cards</Heading>
		<CardList
			cards={cardsNotInPack}
			client:load
			sortOnlyBy={[
				'rarest',
				'common',
				'card-name-asc',
				'card-name-desc',
				'open-date-asc',
				'open-date-desc',
			]}
		/>
	</section>
</Page>
