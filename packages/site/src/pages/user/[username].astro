---
import CardList from '@/components/cards/CardList'
import Page from '@/layouts/Page.astro';
import { getUserAndCardInstances, createNewUser } from '@lil-indigestion-cards/core/user';
import { getUserByLogin } from '@lil-indigestion-cards/core/twitch-helpers';
import { routes, routeNames } from '@/constants';
import AdminOnly from '@/components/AdminOnly.astro';
import { getAllPackTypes } from '@lil-indigestion-cards/core/card';
import { PageTitle, Heading } from '@/components/text';
import UserPackForms from '@/components/pack/UserPackForms';

const redirectCount = Number(Astro.url.searchParams.get('redirect')) || 0;
if (redirectCount > 3) {
	return Astro.redirect(`${routes.USERS}?alert=Username not found`);
}

const id = Astro.params.username;

if (!id) {
	return Astro.redirect(`${routes.USERS}?alert=Username is required`);
}

let data = await getUserAndCardInstances({ username: id });

const twitchData = await getUserByLogin(id);
if (!data) {
	if (twitchData) {
		const newUser = await createNewUser({
			username: twitchData.display_name,
			userId: twitchData.id,
		});
		data = {
			users: [newUser],
			cardInstances: [],
		};
		return Astro.redirect(`${routes.USERS}/${id}?redirect=${redirectCount + 1}`);
	}
	return Astro.redirect(`${routes.USERS}?alert=Username not found`);
}

const { users, cardInstances } = data;
const user = users[0]!;

const cardsNotInPack = cardInstances.filter((card) => !!card.openedAt);

const packTypes = await getAllPackTypes();
---

<Page
	title={user.username}
	class="flex flex-col gap-4"
	breadcrumbs={[{ label: routeNames.USER, href: routes.USERS }, { label: user.username }]}
	pageType="public">
	<header class="flex flex-col items-center gap-4 sm:gap-12 p-4 sm:flex-row sm:items-start">
		<img
			src={twitchData?.profile_image_url}
			width="200"
			class="col-start-1 row-span-full rounded-full"
		/>
		<AdminOnly>
			<section slot="fallback" class="flex flex-col gap-2">
				<PageTitle>{user.username}</PageTitle>
			</section>
			<section class="flex flex-col gap-2">
				<PageTitle>{user.username}</PageTitle>
				<p class="-mt-5">User Id: {user.userId}</p>
				<UserPackForms {user} {packTypes} client:load />
			</section>
		</AdminOnly>
	</header>
	<section class="my-4 grid gap-4 text-center">
		<Heading>Cards</Heading>
		<CardList cards={cardsNotInPack} sessionType={Astro.locals.session?.type} client:load />
	</section>
</Page>
