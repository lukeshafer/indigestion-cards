---
import { getAllRarities } from '@lil-indigestion-cards/core/card';
import Page from '@/layouts/Page.astro';
import UnmatchedImageList from '@/components/UnmatchedImageList.astro';
import { api, routes } from '@/constants';

const rarities = await getAllRarities();
---

<Page
	title="Rarities"
	class="flex flex-col gap-4"
	breadcrumbs={[
		{ label: 'Home', href: '/' },
		{ label: 'Rarities', href: routes.RARITIES },
	]}>
	<UnmatchedImageList type="frame" />
	<sort-table>
		<header class="page-header">
			<h1 class="page-heading">Rarities</h1>
			<a href={routes.ADMIN.CREATE.RARITY} class="button-link">Create New Rarity</a>
		</header>
		<table>
			<thead>
				<tr>
					<th>Name</th>
					<th class="hidden lg:table-cell">Id</th>
					<th data-type="number" class="hidden sm:table-cell">Default Count</th>
					<th data-no-sort>Actions</th>
				</tr>
			</thead>
			<tbody>
				{
					rarities.map(({ rarityName, rarityId, defaultCount, frameUrl }) => (
						<tr class="text-center relative">
							<td>
								<span id={`rarityName-${rarityId}`}>{rarityName}</span>
							</td>
							<td class="hidden lg:table-cell">
								<span id={`rarityId-${rarityId}`}>{rarityId}</span>
							</td>
							<td class="hidden sm:table-cell">
								<span id={`defaultCount-${rarityId}`}>{defaultCount}</span>
							</td>
							<td class="flex flex-wrap gap-2 text-sm justify-center">
								<button
									class="post-button edit-button w-24"
									data-type="submit"
									hx-select=".save-button"
									hx-swap="outerHTML"
									hx-vals={JSON.stringify({ rarityName, rarityId, defaultCount })}
									hx-get={api.RARITY.START_EDIT}>
									Edit
								</button>
								<button
									class="post-button edit-button w-24"
									data-type="delete"
									hx-swap="none"
									hx-vals={JSON.stringify({ rarityId, frameUrl })}
									hx-delete={api.RARITY.DELETE}>
									Delete
									<form-indicator />
								</button>
							</td>
						</tr>
					))
				}
			</tbody>
		</table>
	</sort-table>
</Page>

<script>
	const forms = document.querySelectorAll('#rarity-list form') as NodeListOf<HTMLFormElement>;

	forms.forEach((form) =>
		form.addEventListener('submit', async (e) => {
			const confirmation = confirm('Are you sure you want to delete this rarity?');
			if (!confirmation) e.preventDefault();
		})
	);
</script>
