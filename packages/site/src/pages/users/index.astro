---
import Page from '@site/layouts/Page.astro';
import { getAllPreorders } from '@core/lib/preorder';
import { getAllUsers } from '@core/lib/user';
import { routeNames } from '@site/constants';
import { PageHeader, PageTitle } from '@site/components/text';
import { UsersPage } from '@site/components/user/UsersList';

import { getUserByLogin } from '@core/lib/twitch';

async function loadUserData() {
	const users = await getAllUsers();
	const preorders = await getAllPreorders();

	return Promise.all(
		users
			.sort((a, b) => a.username.localeCompare(b.username))
			.map(async user => ({
				user: user,
				twitch: await getUserByLogin(user.username),
				preorders: preorders.filter(p => p.userId === user.userId),
			}))
	);
}

let pageData = loadUserData();
---

<Page title="Users" breadcrumbs={[{ label: routeNames.USER }]} pageType="public">
	<PageHeader>
		<PageTitle>Users</PageTitle>
	</PageHeader>
	<div class="mx-auto">
		{pageData.then(users => <UsersPage users={users} client:load />)}
	</div>
</Page>
