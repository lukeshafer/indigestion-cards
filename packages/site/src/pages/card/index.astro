---
import Page from '@/layouts/Page.astro';
import CardList from '@/components/cards/CardList';
import UnmatchedImageList from '@/components/UnmatchedImageList.astro';
import { getAllCardDesigns } from '@lil-indigestion-cards/core/card';
import { routeNames, routes, LEGACY_CARD_ID, NO_CARDS_OPENED_ID } from '@/constants';
import { PageTitle, PageHeader, Anchor } from '@/components/text';
import AdminOnly from '@/components/AdminOnly.astro';

const designs = await getAllCardDesigns();

const message = Astro.url.searchParams.get('message') || '';
---

<Page title="All Cards" breadcrumbs={[{ label: routeNames.CARDS }]} pageType="public">
	{message ? <p class="bg-green-200 p-4 text-center text-xl">{message}</p> : null}
	<UnmatchedImageList type="cardDesign" />
	<PageHeader>
		<PageTitle>All Cards</PageTitle>
		<AdminOnly>
			<Anchor href={routes.ADMIN.CREATE.CARD_DESIGN}>Add New Card</Anchor>
		</AdminOnly>
	</PageHeader>
	<CardList
		cards={designs.map((card) => {
			const rarity =
				card.bestRarityFound ??
				card.rarityDetails?.find((r) => r.rarityId === LEGACY_CARD_ID);

			if (rarity?.rarityId === NO_CARDS_OPENED_ID && Astro.locals.session?.type !== 'admin') {
				return {
					rarityName: 'No Cards Opened',
					rarityId: NO_CARDS_OPENED_ID,
					cardName: 'zzz?????',
					cardDescription: '????? ??????????????? ?? ?? ? ?????? ??????',
					artist: '?????',
					designId: '',
					seasonId: '',
					seasonName: '',
					imgUrl: '',
					frameUrl: '/default-base-rarity.png',
					rarityColor: 'gray',
					cardNumber: 1,
					totalOfType: 1,
				};
			}

			return {
				...card,
				rarityName: rarity?.rarityName ?? '',
				rarityId: rarity?.rarityId ?? '',
				frameUrl: rarity?.frameUrl ?? '',
				rarityColor: rarity?.rarityColor ?? '',
				cardNumber: 1,
				totalOfType: 1,
			};
		})}
		sortOnlyBy={['card-name-asc', 'card-name-desc']}
		sessionType={Astro.locals.session?.type}
		client:load
	/>
</Page>
