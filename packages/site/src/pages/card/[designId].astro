---
import Page from '@/layouts/Page.astro';
import Card from '@/components/cards/Card';
import CardList from '@/components/CardList.astro';
import { getCardDesignAndInstancesById } from '@lil-indigestion-cards/core/card';
import { getSiteConfig } from '@lil-indigestion-cards/core/site-config';
import { routes, routeNames } from '@/constants';
import AdminOnly from '@/components/AdminOnly.astro';
import { PageTitle } from '@/components/text';
import AdminDesignStats from '@/components/design/AdminDesignStats';
import DesignOverviewTable from '@/components/design/DesignOverviewTable';
import DeleteDesignButton from '@/components/design/DeleteDesignButton';
import { Heading } from '@/components/text';
import { getRarityStatsOverviewFromDesignAndInstances } from '@lil-indigestion-cards/core/rarity';

const designId = Astro.params.designId;

if (!designId) {
	return Astro.redirect(routes.DESIGNS + '?alert=No design id provided');
}

const session = Astro.locals.session;
if (session?.type !== 'admin') throw new Error('Unauthorized');

const {
	cardDesigns: [design],
	cardInstances: instances,
} = await getCardDesignAndInstancesById({
	designId,
});

if (!design) {
	return Astro.redirect(`${routes.DESIGNS}?error=Design ${designId} not found`);
}

const siteConfig = await getSiteConfig();
const baseRarity = siteConfig?.baseRarity || {
	rarityId: 'default',
	rarityName: 'Default',
	frameUrl: '/default-base-rarity.png',
	rarityColor: '#fff',
};

instances.sort((a, b) =>
	+a.totalOfType === +b.totalOfType
		? a.instanceId !== b.instanceId
			? +a.instanceId - +b.instanceId
			: +a.cardNumber - +b.cardNumber
		: +a.totalOfType - +b.totalOfType
);

const rarityStatsArray = getRarityStatsOverviewFromDesignAndInstances(design, instances);
---

<Page
	title={`${design.cardName} - ${design.seasonName}`}
	class="flex flex-col gap-9"
	breadcrumbs={[{ label: routeNames.CARDS, href: routes.DESIGNS }, { label: design.cardName }]}>
	<header class="flex flex-col items-center gap-4">
		<PageTitle>{design.cardName}</PageTitle>
		<Card {...design} {...baseRarity} cardNumber={1} totalOfType={1} client:load />
	</header>
	<AdminOnly>
		<details>
			<summary class="font-heading text-xl">Stats for Admins</summary>
			<div class="my-4 flex flex-col gap-8">
				<section class="grid text-lg">
					<Heading>Stats Overview</Heading>
					<DesignOverviewTable {rarityStatsArray} client:load />
				</section>
				<AdminDesignStats {rarityStatsArray} client:load />
			</div>
		</details>
		<DeleteDesignButton {...design} client:load />
	</AdminOnly>
	<section class="text-center flex flex-col gap-5">
		<Heading>Instances</Heading>
		<CardList cards={instances} showUsernames />
	</section>
</Page>
