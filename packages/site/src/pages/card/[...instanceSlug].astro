---
import Page from '@/layouts/Page.astro';
import TradingCard from '@/components/TradingCard.astro';
import { getCardInstanceById } from '@lil-indigestion-cards/core/card';
import { routes } from '@/constants';

const slug = Astro.params.instanceSlug;
if (!slug) {
	return Astro.redirect(routes.DESIGNS + '?alert=No instance route provided');
}
const [designId, instanceId] = slug.split('/');

if (!designId) {
	return Astro.redirect(routes.DESIGNS + '?alert=No design id provided');
}
if (!instanceId) {
	return Astro.redirect(routes.DESIGNS + '?alert=No instance id provided');
}

const instance = await getCardInstanceById({ designId, instanceId });

if (!instance) {
	return Astro.redirect(`${routes.DESIGNS}?error=No instance found with id ${instanceId}`);
}

const breadcrumbs = [{ label: 'Home', href: '/' }];

const from = Astro.request.headers.get('referer');
if (from?.includes('user') && instance.username) {
	breadcrumbs.push(
		{ label: 'Users', href: routes.USERS },
		{ label: instance.username, href: `${routes.USERS}/${instance.username}` },
		{
			label: `${instance.cardName}, ${instance.rarityName} #${instance.cardNumber}`,
			href: `${routes.INSTANCES}/${designId}/${instanceId}`,
		}
	);
} else {
	breadcrumbs.push(
		{ label: 'Designs', href: routes.DESIGNS },
		{ label: instance.cardName, href: `${routes.DESIGNS}/${designId}` },
		{
			label: `${instance.rarityName} #${instance.cardNumber}`,
			href: `${routes.INSTANCES}/${designId}/${instanceId}`,
		}
	);
}

const openDate = instance.openedAt
	? new Date(instance.openedAt).toLocaleString()
	: 'Not opened yet';
---

<Page
	title={`${instance.cardName}, ${instance.rarityName} #${instance.cardNumber}`}
	class="flex flex-col gap-9"
	breadcrumbs={breadcrumbs}>
	<header class="flex flex-col gap-4">
		<h1 class="text-3xl font-display italic my-3">
			{instance.cardName}, {instance.rarityName} #{instance.cardNumber}
		</h1>
		<div class="mx-4">
			<TradingCard>
				<img src={instance.imgUrl} width="300" class="max-w-full" />
			</TradingCard>
		</div>
		{
			instance.cardDescription ? (
				<p class="text-lg  max-w-sm">{instance.cardDescription}</p>
			) : null
		}
	</header>
	<section class="text-lg">
		<h2 class="sub-heading">Stats:</h2>
		<p>
			<b>Rarity:</b>
			{instance.rarityName}
		</p>
		<p>
			<b>Card Number:</b>
			{instance.cardNumber}
		</p>
		<p>
			<b>Season:</b>
			<a href={`${routes.SEASONS}/${instance.seasonId}`}>{instance.seasonName}</a>
		</p>
		<p>
			<b>Owner</b>
			{
				instance.username ? (
					<a href={`${routes.USERS}/${instance.username}`}>{instance.username}</a>
				) : (
					'None'
				)
			}
		</p>
		<p>
			<b>Minter</b>
			{
				instance.minterUsername ? (
					<a href={`${routes.USERS}/${instance.minterUsername}`}>
						{instance.minterUsername}
					</a>
				) : (
					'None'
				)
			}
		</p>
		<p>
			<b>Opened at:</b>
			{instance.openedAt ? <time datetime={openDate}>{openDate}</time> : 'Not opened yet'}
		</p>
	</section>
</Page>
