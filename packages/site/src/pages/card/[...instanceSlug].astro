---
import Page from '@/layouts/Page.astro';
import { getCardInstanceById } from '@lil-indigestion-cards/core/card';
import { routeNames, routes } from '@/constants';
import { Heading, PageTitle } from '@/components/text';
import Card from '@/components/cards/Card';
import AdminOnly from '@/components/AdminOnly.astro';

const slug = Astro.params.instanceSlug;
if (!slug) {
	return Astro.redirect(routes.DESIGNS + '?alert=No instance route provided');
}
const [designId, instanceId] = slug.split('/');

if (!designId) {
	return Astro.redirect(routes.DESIGNS + '?alert=No design id provided');
}
if (!instanceId) {
	return Astro.redirect(routes.DESIGNS + '?alert=No instance id provided');
}

const instance = await getCardInstanceById({ designId, instanceId });

if (!instance) {
	return Astro.redirect(`${routes.DESIGNS}?error=No instance found with id ${instanceId}`);
}

const openDate = instance.openedAt
	? new Date(instance.openedAt).toLocaleString('en-US', {
			timeZone: 'America/New_York',
			month: 'long',
			day: 'numeric',
			year: 'numeric',
			hour: 'numeric',
			minute: 'numeric',
			timeZoneName: 'short',
	  })
	: 'Not opened yet';
---

<Page
	title={`${instance.cardName}, ${instance.rarityName} #${instance.cardNumber}`}
	class="flex flex-col gap-6"
	pageType="public"
	breadcrumbs={[
		{ label: routeNames.CARDS, href: routes.DESIGNS },
		{ label: instance.cardName, href: `${routes.DESIGNS}/${designId}` },
		{ label: `${instance.rarityName} #${instance.cardNumber}` },
	]}>
	<header class="flex flex-col items-center gap-4">
		<PageTitle>
			{instance.cardName}, {instance.rarityName} #{instance.cardNumber}
		</PageTitle>
		<div class="mx-4">
			<Card {...instance} client:load />
		</div>
	</header>
	<section class="text-lg mx-auto">
		<Heading>Stats:</Heading>
		<p>
			<b>Rarity: </b>
			{instance.rarityName}
		</p>
		<p>
			<b>Card: </b>
			<a class="underline" href={`${routes.CARDS}/${instance.designId}`}
				>{instance.cardName}</a
			>
		</p>
		<p>
			<b>Card Number: </b>
			{instance.cardNumber}
		</p>
		<AdminOnly>
			<p>
				<b>Season: </b>
				<a class="underline" href={`${routes.SEASONS}/${instance.seasonId}`}
					>{instance.seasonName}</a
				>
			</p>
		</AdminOnly>
		<p>
			<b>Owner: </b>
			{
				instance.username ? (
					<a class="underline" href={`${routes.USERS}/${instance.username}`}>
						{instance.username}
					</a>
				) : (
					'None'
				)
			}
		</p>
		<p>
			<b>Minter: </b>
			{
				instance.minterUsername ? (
					<a class="underline" href={`${routes.USERS}/${instance.minterUsername}`}>
						{instance.minterUsername}
					</a>
				) : (
					'None'
				)
			}
		</p>
		<p>
			<b>Opened at: </b>
			{instance.openedAt ? <time datetime={openDate}>{openDate}</time> : 'Not opened yet'}
		</p>
	</section>
</Page>
