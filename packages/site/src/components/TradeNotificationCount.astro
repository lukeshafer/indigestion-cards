---
interface Props {
	username: string;
}

const { username } = Astro.props;
---

<trade-notification-count {username} hidden>
	<div
		class="text-brand-main absolute right-0 top-0 flex h-5 w-5 min-w-fit -translate-y-1/2 translate-x-1/2 items-center justify-center rounded-full bg-white px-1 text-xs font-semibold outline outline-1">
	</div>
</trade-notification-count>

<script>
	import { get } from '../lib/client/data';

	customElements.define(
		'trade-notification-count',
		class TradeNotificationCount extends HTMLElement {
			div: HTMLDivElement | null;
			constructor() {
				super();
				this.div = this.querySelector('div');
			}

			connectedCallback() {
				this.fetchNotifications();
			}

			async fetchNotifications() {
				const username = this.getAttribute('username');
				if (!username) return this.setCount(0);

				const user = await get('user', [username]);

				return this.setCount(user?.tradeNotifications?.length || 0);
			}

			setCount(count: number) {
				if (this.div) this.div.textContent = count < 100 ? String(count) : '99+';
				if (!count) this.hidden = true;
				else this.hidden = false;
			}
		}
	);
</script>
