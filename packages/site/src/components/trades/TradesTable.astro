---
import type { Trade } from '@lil-indigestion-cards/core/db/trades';
import type { User } from '@lil-indigestion-cards/core/db/users';
import SortTable from '../table/SortTable.astro';
import SortTableCell from '../table/SortTableCell.astro';
import SortTableRow from '../table/SortTableRow.astro';
import SortTableBody from '../table/SortTableBody.astro';
import SortTableHead from '../table/SortTableHead.astro';
import SortTableColumn from '../table/SortTableColumn.astro';
import { routes } from '@/constants';
import { Anchor } from '../text';
import { Icon } from 'astro-icon/components';

interface Props {
	trades: Array<Trade>;
	userTradeNotifications: User['tradeNotifications'];
}

const { trades, userTradeNotifications } = Astro.props;

const sortedTrades = trades.slice().sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

const notifications = userTradeNotifications?.reduce((acc, notif) => {
	const tradenotif = acc.get(notif.tradeId);
	if (!tradenotif) return acc.set(notif.tradeId, notif);
	if (notif.status === 'statusUpdated') return acc.set(notif.tradeId, notif);
	return acc;
}, new Map<string, NonNullable<User['tradeNotifications']>[number]>());

const isLoggedInUsername = (name: string) =>
	name.toUpperCase() === Astro.locals.user?.properties.username.toUpperCase();
---

<SortTable>
	<SortTableHead>
		<SortTableColumn name="dateCreated" startDescending width="15%" showOnBreakpoint="sm">
			Date
		</SortTableColumn>
		<SortTableColumn name="tradeType" startDescending width="14%">Type</SortTableColumn>
		<SortTableColumn name="from" startDescending>From</SortTableColumn>
		<SortTableColumn name="to" startDescending>To</SortTableColumn>
		<SortTableColumn name="status" startDescending showOnBreakpoint="sm">
			Status
		</SortTableColumn>
		<SortTableColumn name="actions" startDescending no-sort />
	</SortTableHead>
	<SortTableBody>
		{
			sortedTrades.map(trade => (
				<SortTableRow highlighted={notifications?.has(trade.tradeId)}>
					<SortTableCell
						column="dateCreated"
						value={trade.createdAt || 0}
						showOnBreakpoint="sm">
						{trade.createdAt ? (
							<time datetime={new Date(trade.createdAt).toISOString()}>
								{new Date(trade.createdAt).toLocaleDateString()}
							</time>
						) : null}
					</SortTableCell>
					<SortTableCell
						column="tradeType"
						value={isLoggedInUsername(trade.senderUsername) ? 'Outgoing' : 'Incoming'}>
						{isLoggedInUsername(trade.senderUsername) ? (
							<Icon
								name="mdi:export"
								title="Out"
								class="mx-auto max-w-8 text-gray-700 dark:text-gray-100"
								size={30}
							/>
						) : (
							<Icon
								name="mdi:import"
								title="In"
								class="mx-auto max-w-8 text-gray-700 dark:text-gray-100"
								size={30}
							/>
						)}
					</SortTableCell>
					<SortTableCell column="from" font="title" value={trade.senderUsername}>
						<a
							href={`${routes.USERS}/${trade.senderUsername}`}
							class="hover:underline focus:underline">
							{trade.senderUsername}
						</a>
					</SortTableCell>
					<SortTableCell column="to" font="title" value={trade.receiverUsername}>
						<a
							href={`${routes.USERS}/${trade.receiverUsername}`}
							class="hover:underline focus:underline">
							{trade.receiverUsername}
						</a>
					</SortTableCell>
					<SortTableCell
						showOnBreakpoint="sm"
						column="status"
						value={
							notifications?.get(trade.tradeId)?.status === 'newMessage'
								? 'New Message'
								: (notifications?.get(trade.tradeId)?.status === 'statusUpdated'
										? 'New Status: '
										: '') +
									trade.status.charAt(0).toUpperCase() +
									trade.status.slice(1)
						}
					/>
					<SortTableCell column="actions" value="">
						<Anchor href={`/trades/${trade.tradeId}`}>View</Anchor>
					</SortTableCell>
				</SortTableRow>
			))
		}
	</SortTableBody>
</SortTable>
