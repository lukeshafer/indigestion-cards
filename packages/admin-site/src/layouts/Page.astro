---
import Base from './Base.astro'
import type { Session } from '@/session'
import Hamburger from '@/components/Hamburger.astro'
import { getAllPacks } from '@lil-indigestion-cards/core/card'
import Breadcrumbs, { type Path } from '@/components/Breadcrumbs.astro'
import { Icon } from 'astro-icon'

export interface Props {
	title: string
	class?: string
	session: Session
	breadcrumbs?: Path[]
}

const alert = Astro.url.searchParams.get('alert')
const alertType =
	Astro.url.searchParams.get('alertType') ?? Astro.url.searchParams.get('type') ?? 'error'
const alertColor =
	{
		success: 'bg-green-200',
		error: 'bg-red-200',
	}[alertType] ?? 'bg-red-200'

const currentPage = Astro.url.pathname
const adminLinks = [
	{ href: '/user', title: 'Users' },
	{ href: '/design', title: 'Designs' },
	{ href: '/season', title: 'Seasons' },
	{ href: '/rarity', title: 'Rarities' },
]

const packs = await getAllPacks()

const actionLinks = [
	{ href: '/open-packs', title: 'Open Packs', id: 'open-packs', count: packs.length },
	{ href: '/give-pack', title: 'Give Pack', id: 'give-pack' },
	{ href: '/give-card', title: 'Give Card', id: 'give-card' },
]
---

<Base title={Astro.props.title} session={Astro.props.session}>
	<div class="page-layout grid h-[100svh] overflow-hidden">
		<side-nav class="overflow-y-scroll">
			<nav class="max-w-[16rem] pt-28 md:pt-10 pb-4 flex flex-col gap-8 text-white min-h-[100svh]">
				<a
					href="/"
					title="Home"
					class="flex flex-col text-center font-display text-white text-shadow">
					<span class="italic text-3xl">indigestion</span>
					<span class="text-2xl -mt-1">card studio</span>
				</a>
				<div class="my-10 flex-1 self-center flex flex-col gap-8 items-center px-12">
					{
						actionLinks.map((actionLink) => (
							<a
								href={actionLink.href}
								title={actionLink.title}
								class="action-link shine text-shadow">
								{actionLink.count ? (
									<span class="absolute -top-2 -right-2 w-8 h-8 bg-white flex items-center justify-center rounded-full text-lg text-black no-text-shadow">
										{packs.length}
									</span>
								) : null}
								{actionLink.title}
							</a>
						))
					}
				</div>
				<div class="pb">
					<h2 class="text-2xl font-heading text-brand-dark font-medium my-3 p-1 px-6">
						Administration
					</h2>
					{
						adminLinks.map(({ href, title }) =>
							currentPage === href ? (
								<a
									href={href}
									title={title}
									class="text-xl font-heading font-medium block bg-white text-black px-6 py-1 my-1">
									{title}
								</a>
							) : (
								<a
									href={href}
									title={title}
									class="text-xl font-heading font-medium block text-shadow px-6 py-1 my-1 hover:bg-gray-900/20">
									{title}
								</a>
							)
						)
					}
				</div>
				<div class="px-4 py-2 flex items-center gap-3 relative">
					<a href="/config" title="Settings" class="w-max group brand-shadow">
						<span class="visually-hidden">Settings</span>
						<Icon
							name="mdi:gear"
							class="w-10 group-hover:rotate-[30deg] transition-transform duration-300 group-hover:scale-110"
						/>
					</a>
					<div
						class="user-menu absolute bottom-full right-0 bg-white text-black w-11/12 p-1 hidden">
						<a href="/auth/logout" title="Logout" class="block hover:bg-gray-100 p-3"> Logout</a>
					</div>
					<button
						class="user-button text-shadow font-display lowercase italic"
						title={Astro.props.session?.properties?.username}>
						{Astro.props.session?.properties?.username}
					</button>
				</div>
			</nav>
		</side-nav>
		<div class="md:col-start-2 overflow-y-scroll relative">
			<header class="text-white text-shadow flex sticky top-0 z-10 h-14">
				<div data-for-side-nav class="toggle-btn text-lg brand-shadow px-2 py-2 z-100">
					<Hamburger />
				</div>
				<Breadcrumbs path={Astro.props.breadcrumbs ?? []} />
			</header>
			<main class={(Astro.props.class ?? '') + ' p-6 col-start-2'}>
				{alert ? <div class={`p-4 ${alertColor} mb-4`}>{alert}</div> : null}
				<slot />
			</main>
		</div>
	</div>
</Base>

<style>
	.page-layout {
		grid-template-columns: 16rem 1fr;
	}

	header {
		background-color: var(--color-main-dark);
	}

	.toggle-btn {
		display: none;
		--color: white;
		--open-color: white;
		--spacing: 0.34em;
		--thickness: 0.16em;
		--size: 1rem;
		--width: 1.3em;
		--text-value: calc(255 - 255 * var(--isClosed));
		padding-left: 1rem;
		color: rgb(var(--text-value), var(--text-value), var(--text-value));
		z-index: 1;
		background: transparent;
		font-weight: 900;
		transition: transform 0.3s ease-in-out, color 0.3s ease-in-out;
		align-self: center;
	}

	main {
		z-index: 0;
	}

	side-nav {
		position: relative;
	}

	nav::-webkit-scrollbar {
		display: none;
	}

	nav {
		/* to bottom right */
		background-image: linear-gradient(125deg, var(--color-main), var(--color-secondary));
	}

	.action-link {
		font-size: 2.25rem /* 36px */;
		line-height: 2.5rem /* 40px */;
		text-transform: uppercase;
		display: block;
		text-align: center;
		background-color: var(--color-tertiary);
		padding: 0.5rem 1rem;
		font-family: var(--font-heading);
		font-weight: 800;
		border-radius: 1rem;
		position: relative;
		transition: scale 50ms ease-in-out;
	}

	.action-link:hover {
		scale: 1.05;
	}

	@media (max-width: 768px) {
		.page-layout {
			grid-template-columns: 1fr;
		}

		side-nav {
			position: absolute;
			top: 0;
			left: 0;
			bottom: 0;
			z-index: 1;
			--isClosed: 1;
			transform: translateX(calc(var(--isClosed) * -100%));
			transition: transform 0.3s ease-in-out;
		}

		.toggle-btn {
			display: block;
			transform: translateX(calc(var(--isClosed) * 100%));
		}
	}
</style>

<script>
	class SideNav extends HTMLElement {
		isClosed = true
		constructor() {
			super()
		}

		connectedCallback() {
			const hamburgerButton = document.querySelector(
				'[data-for-side-nav] button'
			) as HTMLButtonElement
			const nav = this.querySelector('nav') as HTMLDivElement
			hamburgerButton.addEventListener('click', () => {
				this.isClosed = !this.isClosed
				this.style.setProperty('--isClosed', `${+this.isClosed}`)
				hamburgerButton.setAttribute('aria-pressed', `${!this.isClosed}`)
				nav.setAttribute('aria-expanded', `${this.isClosed}`)
			})

			const userMenu = this.querySelector('.user-menu') as HTMLDivElement
			const userButton = this.querySelector('.user-button') as HTMLButtonElement
			userButton.addEventListener('click', () => {
				userMenu.classList.toggle('hidden')
			})
		}
	}

	customElements.define('side-nav', SideNav)
</script>
