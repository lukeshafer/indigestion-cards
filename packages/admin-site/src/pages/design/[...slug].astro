---
import PostButton from '@/components/form/PostButton.astro'
import Page from '@/layouts/Page.astro'
import TradingCard from '@/components/TradingCard.astro'
import { useUser } from '@/session'
import { getCardDesignAndInstancesById } from '@lil-indigestion-cards/core/card'
import { Api } from 'sst/node/api'

const user = useUser(Astro.cookies)
if (user?.type !== 'user') return Astro.redirect('/404')

const slug = Astro.params.slug
if (!slug) {
	return Astro.redirect('/design?error=No design id provided')
}

const from = new URL(Astro.request.headers.get('referer') ?? '/').pathname.split('/')[1]
const [seasonId, designId] = slug.split('/')

if (!seasonId) {
	return Astro.redirect(`/design?alert=No season id provided: ${slug}`)
}

if (!designId) {
	return Astro.redirect(`/season/${seasonId}`)
}

const {
	season: [season],
	cardDesigns: [design],
	cardInstances,
} = await getCardDesignAndInstancesById({ designId, seasonId })
const openedCards = cardInstances.filter((card) => card.packId === undefined)

if (!design) {
	return Astro.redirect('/design?error=No design found with that id')
}

const breadcrumbs = [{ label: 'Home', href: '/' }]

if (from === 'design') {
	breadcrumbs.push(
		{ label: 'Designs', href: `/design` },
		{ label: design.cardName, href: `/design/${slug}` }
	)
} else {
	breadcrumbs.push(
		{ label: 'Seasons', href: `/season` },
		{ label: season!.seasonName, href: `/season/${season!.seasonId}` },
		{ label: design.cardName, href: `/design/${slug}` }
	)
}
---

<Page
	title={`${design.cardName} - ${season!.seasonName}`}
	class="flex flex-col gap-4"
	session={user}
	breadcrumbs={breadcrumbs}>
	<h1 class="text-3xl font-display italic my-3">{design.cardName}</h1>
	<TradingCard>
		<img src={design.imgUrl} width="300" class="max-w-full" />
	</TradingCard>
	{design.cardDescription ? <p class="text-lg  max-w-sm">{design.cardDescription}</p> : null}
	<ul class="border border-gray-300 p-4 max-w-4xl">
		{
			openedCards.length > 0 ? (
				openedCards.map((card) => (
					<li>
						<a href={`/card/${card.instanceId}`}>{card.rarityId}: </a>
						<a href={`/user/${card.userId}`}>Owned by {card.username}</a>
					</li>
				))
			) : (
				<p>No one has this card yet!</p>
			)
		}
	</ul>
	<PostButton
		class="bg-red-500 hover:bg-red-700 text-black hover:text-white"
		id="delete-design-form"
		url={`${Api.api.url}/delete-card-design/${seasonId}/${designId}?redirectUrl=${Astro.url.protocol}${Astro.url.host}/design`}
		label="Delete Card"
	/>
</Page>

<script>
	const form = document.getElementById('delete-design-form') as HTMLFormElement

	form.addEventListener('submit', async (e) => {
		// prevent default, confirm, then resume
		const confirmation = confirm('Are you sure you want to delete this design?')
		if (!confirmation) e.preventDefault()
	})
</script>
