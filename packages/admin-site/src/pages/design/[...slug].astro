---
import PostButton from '@/components/form/PostButton.astro'
import Page from '@/layouts/Page.astro'
import { getCardDesignAndInstancesById } from '@lil-indigestion-cards/core/card'
import { Api } from 'sst/node/api'

const slug = Astro.params.slug

if (!slug) {
	return Astro.redirect('/design?error=No design id provided')
}

const [seasonId, designId] = slug.split('/')

if (!seasonId || !designId) {
	return Astro.redirect(`/design?alert=Invalid design id provided: ${slug}`)
}

const {
	cardDesigns: [design],
	cardInstances,
} = await getCardDesignAndInstancesById({ designId, seasonId })

if (!design) {
	return Astro.redirect('/design?error=No design found with that id')
}
---

<Page title="Designs" class="grid gap-4 p-4 justify-center justify-items-center">
	<h1 class="text-2xl">Card name: {design.cardName}</h1>
	{design.cardDescription ? <p class="text-lg">Description: {design.cardDescription}</p> : null}
	<ul class="border border-gray-300 p-4">
		<h2 class="text-xl">Cards with this design:</h2>
		{
			cardInstances.length > 0 ? (
				cardInstances.map((card) => (
					<li>
						<a href={`/card/${card.instanceId}`}>{card.rarityId}: </a>
						<a href={`/user/${card.userId}`}>Owned by {card.username}</a>
					</li>
				))
			) : (
				<p>No cards with this design yet</p>
			)
		}
	</ul>
	<PostButton
		class="bg-red-500 hover:bg-red-700 text-black hover:text-white"
		id="delete-design-form"
		url={`${Api.api.url}/delete-card-design/${seasonId}/${designId}?redirectUrl=${Astro.url.protocol}${Astro.url.host}/design`}
		label="Delete Design"
	/>
</Page>

<script>
	const form = document.getElementById('delete-design-form') as HTMLFormElement

	form.addEventListener('submit', async (e) => {
		// prevent default, confirm, then resume
		const confirmation = confirm('Are you sure you want to delete this design?')
		if (!confirmation) e.preventDefault()
	})
</script>
