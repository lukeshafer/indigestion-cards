---
import { Api } from 'sst/node/api'
import { getAllRarities } from '@lil-indigestion-cards/core/card'
import { useUser } from '@/session'
import H1 from '@/components/H1.astro'
import Box from '@/components/Box.astro'
import Page from '@/layouts/Page.astro'
import UnmatchedImageList from '@/components/UnmatchedImageList.astro'
import PostButton from '@/components/form/PostButton.astro'

const user = useUser(Astro.cookies)
if (!user) return Astro.redirect('/')

const rarities = await getAllRarities()
---

<Page title="Rarities" class="grid p-8 gap-8 justify-center justify-items-center" session={user}>
	<UnmatchedImageList type="frame" />
	<H1>Rarities</H1>
	<ul id="rarity-list">
		{
			rarities.map(({ rarityName, rarityId }) => (
				<li>
					<Box>
						<div class="flex gap-4 flex-col items-center">
							<p>{rarityName}</p>
							<PostButton
								url={`${Api.api.url}/delete-rarity/${rarityId}?name=${rarityName}`}
								id={`delete-rarity-${rarityId}`}
								label="Delete"
								class="bg-red-500 text-black hover:bg-red-700 hover:text-white text-xs"
							/>
						</div>
					</Box>
				</li>
			))
		}
	</ul>
	<a href="/create/rarity" class="text-lg bg-pink-200 p-4 rounded-xl w-max">Create New Rarity</a>
</Page>

<script>
	const forms = document.querySelectorAll('#rarity-list form') as NodeListOf<HTMLFormElement>

	forms.forEach((form) =>
		form.addEventListener('submit', async (e) => {
			const confirmation = confirm('Are you sure you want to delete this rarity?')
			if (!confirmation) e.preventDefault()
		})
	)
</script>
