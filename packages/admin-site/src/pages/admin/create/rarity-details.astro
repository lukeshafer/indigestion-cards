---
import Page from '@/layouts/Page.astro'
import Form from '@/components/form/Form.astro'
import { useUser } from '@/session'
import PostButton from '@/components/form/PostButton.astro'
import { api, routes } from '@/constants'

const user = useUser(Astro.cookies)
if (user?.type !== 'user') return Astro.redirect('/404')

const bucket = Astro.url.searchParams.get('bucket')
const key = Astro.url.searchParams.get('key')

if (!bucket || !key) {
	return Astro.redirect('/?alert=Please upload an image first')
}

const imgUrl = `https://${bucket}.s3.amazonaws.com/${key}`
---

<Page
	title="Add Rarity Details"
	breadcrumbs={[
		{ label: 'Home', href: '/' },
		{ label: 'Rarities', href: '/rarity' },
		{ label: 'New Rarity', href: '/create/rarity' },
		{ label: 'Details', href: '/create/rarity-details' },
	]}
	session={user}>
	<h1 class="page-heading">Add Rarity</h1>
	<div class="flex flex-col pt-8 gap-8 max-w-4xl">
		<div>
			<img src={imgUrl} class="w-60 h-auto object-contain mb-4" />
			<PostButton
				label="Delete Draft"
				type="delete"
				url={`${api.DELETE_UNMATCHED_IMAGE}/${key}?redirect=${routes.RARITIES}`}
				id="delete"
				hiddenProperties={[{ name: 'type', value: 'frame' }]}
			/>
		</div>

		<Form action={api.CREATE_RARITY} method="post">
			<input type="hidden" name="imgUrl" value={imgUrl} />
			<input type="hidden" name="imageKey" value={key} />
			<div class="input-group">
				<label for="rarityName">Rarity Name</label>
				<input id="rarityName" name="rarityName" type="text" />
			</div>
			<div class="input-group">
				<label for="rarityId">Rarity ID</label>
				<input
					id="rarityId"
					name="rarityId"
					type="text"
					readonly
					data-edit-button
					data-id-from="rarityName"
					pattern="[a-z0-9-]+"
				/>
			</div>
			<div class="input-group">
				<label for="defaultCount">Default number per card</label>
				<input id="defaultCount" name="defaultCount" type="number" value="0" />
			</div>
			<button type="submit">Save</button>
		</Form>
	</div>
</Page>
