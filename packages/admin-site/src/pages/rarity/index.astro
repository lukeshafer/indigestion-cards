---
import { getAllRarities } from '@lil-indigestion-cards/core/card'
import { useUser } from '@/session'
import Page from '@/layouts/Page.astro'
import UnmatchedImageList from '@/components/UnmatchedImageList.astro'
import TradingCard from '@/components/TradingCard.astro'
import { routes } from '@/constants'

const user = useUser(Astro.cookies)
if (user?.type !== 'user') return Astro.redirect('/404')

const rarities = await getAllRarities()
---

<Page
	title="Rarities"
	class="flex flex-col gap-4"
	session={user}
	breadcrumbs={[
		{ label: 'Home', href: '/' },
		{ label: 'Rarities', href: routes.RARITIES },
	]}>
	<UnmatchedImageList type="frame" />
	<div class="flex flex-wrap gap-8">
		<h1 class="page-heading">Rarities</h1>
		<a href={routes.ADMIN.CREATE.RARITY} class="button-link">Create New Rarity</a>
	</div>
	<ul id="rarity-list flex flex-wrap gap-8">
		{
			rarities.map(({ rarityName, rarityId, frameUrl, defaultCount }) => (
				<li class="flex gap-4 flex-col items-center w-max">
					<a href={`${routes.RARITIES}/${rarityId}`} class="text-center">
						<TradingCard>
							<img src={frameUrl} width="200" alt="" />{' '}
						</TradingCard>
						<h2 class="mt-4 font-display font-bold italic text-2xl">{rarityName}</h2>
					</a>
					<p>Default Count: {defaultCount}</p>
				</li>
			))
		}
	</ul>
</Page>

<script>
	const forms = document.querySelectorAll('#rarity-list form') as NodeListOf<HTMLFormElement>

	forms.forEach((form) =>
		form.addEventListener('submit', async (e) => {
			const confirmation = confirm('Are you sure you want to delete this rarity?')
			if (!confirmation) e.preventDefault()
		})
	)
</script>
