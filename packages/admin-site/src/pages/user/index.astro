---
import Page from '@/layouts/Page.astro'
import { Icon } from 'astro-icon'
import { useUser } from '@/session'
import { getAllUsers } from '@lil-indigestion-cards/core/user'

const user = useUser(Astro.cookies)
if (!user) {
	Astro.redirect('/public')
}

const users = await getAllUsers()
---

<Page title="Users" breadcrumbs={[{ label: 'Home', href: '/' }, { label: 'Users' }]} session={user}>
	<h1 class="page-heading">Users</h1>
	<user-table>
		<table>
			<thead>
				<tr>
					<th class="w-3/4">Username</th>
					<th>Cards</th>
					<th>Packs</th>
				</tr>
			</thead>
			<tbody>
				{
					users.map((user) => (
						<tr>
							<td>
								<a href={`/user/${user.userId}`}>{user.username}</a>
							</td>
							<td>
								<Icon name="mdi:cards" aria-hidden="true" />
								<span>{user.cardCount}</span>
							</td>
							<td>
								<Icon name="mdi:gift" aria-hidden="true" />
								<span>{user.packCount}</span>
							</td>
						</tr>
					))
				}
			</tbody>
		</table>
	</user-table>
</Page>

<style>
	table {
		table-layout: fixed;
		text-align: center;
		width: 100%;
		max-width: 60rem;
	}

	th {
		cursor: pointer;
	}

	tbody td {
		font-weight: 500;
		padding: 1.5rem;
		position: relative;
	}

	tbody td span {
		position: relative;
	}

	tbody td [astro-icon] {
		width: 3rem;
		color: white;
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
	}

	tbody tr:nth-child(even) [astro-icon] {
		color: lightgray;
	}

	tbody tr:nth-child(even) {
		@apply bg-gray-50;
	}

	tbody tr:nth-child(odd) {
		@apply bg-gray-200;
	}

	th[data-mode='ascending']::after {
		content: '▲';
	}

	th[data-mode='descending']::after {
		content: '▼';
	}
</style>

<script>
	class UserTable extends HTMLElement {
		constructor() {
			super()
		}

		connectedCallback() {
			const headings = Array.from(this.querySelectorAll('th'))
			const body = this.querySelector('tbody')!
			const rows = Array.from(body.querySelectorAll('tr'))
			const originalRows = rows.slice()
			headings.forEach((th, index) => {
				th.addEventListener('click', () => {
					const currentMode = th.dataset.mode || 'none'
					const newMode =
						currentMode === 'none'
							? 'ascending'
							: currentMode === 'ascending'
							? 'descending'
							: 'none'

					th.dataset.mode = newMode
					if (newMode === 'none') {
						originalRows.forEach((row) => {
							body.appendChild(row)
						})
						return
					}

					const isAscending = newMode === 'ascending'
					const sortedRows = rows.sort((a, b) => {
						const aVal = a.children[index]!.textContent!
						const bVal = b.children[index]!.textContent!
						if (aVal < bVal) {
							return isAscending ? -1 : 1
						}
						if (aVal > bVal) {
							return isAscending ? 1 : -1
						}
						return 0
					})
					sortedRows.forEach((row) => {
						body.appendChild(row)
					})
				})
			})
		}
	}

	customElements.define('user-table', UserTable)
</script>
